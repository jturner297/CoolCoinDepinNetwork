<!--
===========================================================
COOL-COIN DASHBOARD (old to be depreciated)— Overview
Author: Justin Turner
Acknowledgments:
• Chris Baden — Wrote an alternative, unused dashboard script in python. 
• Joel Metukmebong — Contributed an early conceptual prototype dashboard.
  (not used in this final implementation)


This webpage displays a live dashboard for multiple Cool-Coin wallets.
It pulls real-time blockchain data from a validator node and updates
each wallet’s panel once per second.

Key Features:
• Shows live sensor readings (temperature, pressure, humidity) attached
  to the most recent MINT transaction for each wallet. 
• Displays wallet statistics including confirmed balance, pending coins,
  total mined coins, and net reward/transfer amount.
• Fetches data from the blockchain (/chain) and mempool (/mempool) to
  determine balances and the latest transaction associated with each wallet.
• Supports multiple wallets by mapping public keys to dashboard elements.
• Automatically updates timestamps, transaction types, server status,
  and all sensor/financial data with each refresh cycle.
• User interface is styled with a dark theme, sky-blue wallet labels,
  and responsive flexbox layout.

Purpose:
Provides a clean, real-time monitoring UI for the Cool-Coin DePIN network,
useful for debugging, visualization, and demo purposes.
===========================================================
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cool Coins Dashboard</title>
    <style>
      body {
        background-color: black; /* Page background color */
        color: white; /* Default text color */
        font-family: monospace; /* Font for dashboard, fixed width */
        display: flex; /* Use Flexbox for layout */
        flex-direction: column; /* Arrange child elements vertically */
        align-items: center; /* Center child elements horizontally */
        padding: 20px; /* Space around the page content */
      }
      h1 {
        font-size: 2.5em; /*Large header*/
        margin-bottom: 30px; /* Empty Space below header */
        text-align: center; /* Center text */
      }
      .dashboard-container {
        display: flex; /* Flex layout for multiple dashboards */
        gap: 20px; /* Space between each dashboard */
        justify-content: center; /* Center dashboards horizontally */
        flex-wrap: wrap; /* Allow content to wrap to next line if needed */
        width: 100%; /* Container spans full width */
      }
      .dashboard {
        background-color: #111;
        border: 2px solid white;
        border-radius: 20px;
        padding: 20px;
        width: 300px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .wallet-label {
        text-align: center;
        font-weight: bold;
        font-size: 1.3em;
        margin-bottom: 5px;
        color: #87ceeb; /* sky blue for brand recognition  */
      }
      .transaction-line {
        text-align: center;
        font-size: 0.85em; /* smaller so text fits on one line */
        margin-bottom: 10px;
        white-space: nowrap; /* prevent wrapping */
        overflow: hidden;
        text-overflow: ellipsis; /* truncate if too long */
      }

      .transaction-time {
        font-weight: bold;
      }

      .transaction-timestamp {
        font-weight: normal;
        margin-left: 5px;
      }
      .section {
        background-color: #222;
        border: 1px solid white;
        border-radius: 10px;
        padding: 10px 15px;
      }
      .section-title {
        font-weight: bold;
        text-decoration: underline;
        margin-bottom: 5px;
      }
      .line-item {
        margin-left: 10px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <!-- Visuals -->
    <h1>COOL-COIN DASHBOARD</h1>
    <!-- Main page header -->

    <div class="dashboard-container">
      <!-- Container for all wallet dashboards -->
      <!-- Wallet 1 -->
      <div class="dashboard">
        <!-- left wallet block -->
        <div class="wallet-label">Wallet 1</div>
        <!-- Wallet identifier -->
        <div class="transaction-line">
          <!-- Transaction line with label + timestamp -->
          <span class="transaction-time">Transaction Time: </span>
          <!-- Label -->
          <span id="timestamp1" class="transaction-timestamp">--</span>
          <!-- Timestamp placeholder -->
        </div>

        <div class="section">
          <!-- Readings section -->
          <div class="section-title">Readings:</div>
          <div class="line-item">
            Temperature : <span id="temp1">--</span> °C
          </div>
          <div class="line-item">Pressure : <span id="pres1">--</span> hPa</div>
          <div class="line-item">Humidity : <span id="hum1">--</span> %</div>
        </div>
        <div class="section">
          <!-- Server section -->
          <div class="section-title">Server:</div>
          <div class="line-item">Status : <span id="status1">--</span></div>
          <div class="line-item">
            Transaction Type : <span id="txType1">--</span>
          </div>
          <div class="line-item">
            Amount : <span id="reward1">--</span> Cool-Coins
          </div>
        </div>
        <div class="section">
          <!-- Wallet section -->
          <div class="section-title">Wallet:</div>
          <div class="line-item">
            Confirmed Balance : <span id="confirmed1">--</span>
          </div>
          <div class="line-item">
            Coins Mined : <span id="pending1">--</span>
          </div>
          <div class="line-item">
            Total Balance : <span id="total1">--</span>
          </div>
        </div>
      </div>

      <!-- Wallet 2 -->
      <div class="dashboard">
        <!-- right wallet block -->
        <div class="wallet-label">Wallet 2</div>
        <!-- Wallet identifier -->
        <div class="transaction-line">
          <!-- Transaction line -->
          <span class="transaction-time">Transaction Time: </span>
          <!-- Label -->
          <span id="timestamp2" class="transaction-timestamp">--</span>
          <!-- Timestamp placeholder -->
        </div>

        <div class="section">
          <div class="section-title">Readings:</div>
          <!-- Readings section -->
          <div class="line-item">
            Temperature : <span id="temp2">--</span> °C
          </div>
          <div class="line-item">Pressure : <span id="pres2">--</span> hPa</div>
          <div class="line-item">Humidity : <span id="hum2">--</span> %</div>
        </div>
        <div class="section">
          <div class="section-title">Server:</div>
          <!-- Server section -->
          <div class="line-item">Status : <span id="status2">--</span></div>
          <div class="line-item">
            Transaction Type : <span id="txType2">--</span>
          </div>
          <div class="line-item">
            Amount : <span id="reward2">--</span> Cool-Coins
          </div>
        </div>
        <div class="section">
          <!-- Wallet balance section -->
          <div class="section-title">Wallet:</div>
          <div class="line-item">
            Confirmed Balance : <span id="confirmed2">--</span>
          </div>
          <div class="line-item">
            Coins Mined : <span id="pending2">--</span>
          </div>
          <div class="line-item">
            Total Balance : <span id="total2">--</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Public Keys Array
      const WALLETS = [
        {
          addr: `-----BEGIN PUBLIC KEY-----
MCowBQYDK2VwAyEAYAg3HLWQ/H7bhRl7pL/YIhdClzpxiMaGG/A0qMUeg50=
-----END PUBLIC KEY-----`,
          suffix: "1",
        },
        {
          addr: `-----BEGIN PUBLIC KEY-----
MCowBQYDK2VwAyEACc9KcsPrVITBEgZMSX1rgF+MI56fKH+Jd/MjGVplGA0=
-----END PUBLIC KEY-----`,
          suffix: "2",
        },
      ];

      function normalizeAddr(addr) {
        return addr.replace(/\s+/g, "");
      } //Helper function that normalizes wallet (remove all whitespace)
      async function fetchBlockchain() {
        try {
          return await (await fetch("http://192.168.1.1:8000/chain")).json();
        } catch {
          return [];
        }
      } //fetch blockchain for pending transactions, return empty on error
      async function fetchMempool() {
        try {
          return await (await fetch("http://192.168.1.1:8000/mempool")).json();
        } catch {
          return [];
        }
      } //fetch mempool for pending transactions, return empty on error

      const lastTxs = [null, null]; // Array track latest transaction per wallet

      async function updateDashboardForWallet(wallet, index) {
        const normWallet = normalizeAddr(wallet.addr);
        const [blockchain, mempool] = await Promise.all([
          fetchBlockchain(),
          fetchMempool(),
        ]);

        //these lines control what is shown when no data is available
        let confirmed = 0,
          pending = 0,
          latestTx = null;
        let reading = { temperature: 0, pressure: 0, humidity: 0 };
        let timestamp = "--",
          reward = 0;
        let txType = "--"; // default if no transaction

        // Loop through blockchain to calculate confirmed balances and find latest tx
        for (const block of blockchain) {
          for (const tx of block.transactions) {
            const toAddr = normalizeAddr(tx.to_addr); // Normalize recipient address
            const fromAddr = normalizeAddr(tx.from_addr); // Normalize sender address

            if (tx.type === "MINT" && toAddr === normWallet)
              confirmed += tx.amount; // Add minted coins to confirmed
            if (tx.type === "TRANSFER") {
              // Adjust balances for transfers
              if (toAddr === normWallet) confirmed += tx.amount;
              if (fromAddr === normWallet) confirmed -= tx.amount;
            }
            if (toAddr === normWallet || fromAddr === normWallet) latestTx = tx; // Update latest transaction
          }
        }

        // Iterate through mempool to calculate pending transaction
        for (const tx of mempool) {
          const toAddr = normalizeAddr(tx.to_addr);
          const fromAddr = normalizeAddr(tx.from_addr);

          if (
            (tx.type === "MINT" && toAddr === normWallet) ||
            (tx.type === "TRANSFER" &&
              (toAddr === normWallet || fromAddr === normWallet))
          ) {
            if (tx.type === "MINT" && toAddr === normWallet)
              pending += tx.amount; // Add pending minted coins
            latestTx = tx; // Update latest transaction
          }
        }

        // Stores latest transaction for this wallet
        if (
          latestTx &&
          (normalizeAddr(latestTx.to_addr) === normWallet ||
            normalizeAddr(latestTx.from_addr) === normWallet)
        )
          lastTxs[index] = latestTx;

        // If transaction exists, use its data
        if (lastTxs[index]) {
          reading = lastTxs[index].reading || reading; // use sensor readings if available
          timestamp = lastTxs[index].timestamp || "--"; // use transaction timestamp
          reward = lastTxs[index].amount || 0; // use reward amount
          txType = lastTxs[index].type || "--"; // get transaction type
        } else {
          //it does not exist
          // Placeholder - No transaction yet so time and type can't be established
          timestamp = "MM-DD-YYYY --:--:-- UTC";
          txType = "--";
        }
        if (latestTx) {
          const normTo = normalizeAddr(latestTx.to_addr);
          const normFrom = normalizeAddr(latestTx.from_addr);
          if (normWallet === normTo) {
            reward = +latestTx.amount; // received coins
          } else if (normWallet === normFrom) {
            reward = -latestTx.amount; // sent coins
          } else {
            reward = 0;
          }
        }

        // Update HTML elements with current server data
        document.getElementById(`timestamp${wallet.suffix}`).textContent =
          timestamp;
        document.getElementById(`txType${wallet.suffix}`).textContent = txType;
        document.getElementById(`temp${wallet.suffix}`).textContent =
          reading.temperature?.toFixed(2) || "--";
        document.getElementById(`pres${wallet.suffix}`).textContent =
          reading.pressure?.toFixed(2) || "--";
        document.getElementById(`hum${wallet.suffix}`).textContent =
          reading.humidity?.toFixed(2) || "--";
        document.getElementById(`status${wallet.suffix}`).textContent = lastTxs[
          index
        ]
          ? "Valid"
          : "No transactions yet";
        document.getElementById(`reward${wallet.suffix}`).textContent =
          reward.toFixed(2);
        document.getElementById(`confirmed${wallet.suffix}`).textContent =
          confirmed.toFixed(2);
        document.getElementById(`pending${wallet.suffix}`).textContent =
          pending.toFixed(2);
        document.getElementById(`total${wallet.suffix}`).textContent = (
          confirmed + pending
        ).toFixed(2);
      }

      // Update all wallet dashboards simultaneously
      async function updateAllDashboards() {
        await Promise.all(
          WALLETS.map((wallet, i) => updateDashboardForWallet(wallet, i))
        );
      }

      // Refresh dashboards every second
      setInterval(updateAllDashboards, 1000);
      updateAllDashboards(); // Initial load
    </script>
  </body>
</html>
